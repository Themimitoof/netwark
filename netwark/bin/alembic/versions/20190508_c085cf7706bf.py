"""Update operations tables

Revision ID: c085cf7706bf
Revises: e5e016a16fac
Create Date: 2019-05-08 00:22:57.288551

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

from netwark.models import types

# revision identifiers, used by Alembic.
revision = 'c085cf7706bf'
down_revision = 'e5e016a16fac'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('operation_result',
        sa.Column('id', types.UUID(), nullable=False),
        sa.Column('operation', types.UUID(), nullable=True),
        sa.Column('worker', sa.String(), nullable=False),
        sa.Column('queue', sa.String(), nullable=False),
        sa.Column('status', sa.Enum('waiting', 'progress', 'done', 'error', 'timeout', name='en_operation_status'), nullable=False),
        sa.Column('payload', types.JSON(), nullable=False),
        sa.Column('created_at', sa.TIMESTAMP(), nullable=False),
        sa.Column('updated_at', sa.TIMESTAMP(), nullable=False),
        sa.ForeignKeyConstraint(['operation'], ['operation.id'], name=op.f('fk_operation_result_operation_operation')),
        sa.PrimaryKeyConstraint('id', name=op.f('pk_operation_result'))
    )

    op.add_column('operation', sa.Column('payload', types.JSON(), nullable=True))
    op.add_column('operation', sa.Column('queues', sa.String(), nullable=False))
    op.add_column('operation', sa.Column('status', sa.Enum('waiting', 'progress', 'done', 'error', 'timeout', name='en_operation_status'), nullable=False))
    op.add_column('operation', sa.Column('updated_at', sa.TIMESTAMP(), nullable=False))
    op.alter_column('operation', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False)
    op.drop_column('operation', 'options')
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('operation_result')

    op.add_column('operation', sa.Column('options', sa.VARCHAR(), autoincrement=False, nullable=True))
    op.alter_column('operation', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True)
    op.drop_column('operation', 'updated_at')
    op.drop_column('operation', 'status')
    op.drop_column('operation', 'queues')
    op.drop_column('operation', 'payload')
    op.execute('DROP TYPE en_operation_status;')

    # ### end Alembic commands ###
